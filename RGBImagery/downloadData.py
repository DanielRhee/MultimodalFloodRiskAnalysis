import requests
import math
import time

# -----------------------------
# CONFIGURATION
# -----------------------------
API_KEY = ""  # Replace with your actual Sentinel Hub API key

# Output folder
OUTPUT_FOLDER = "./tiles/"

# Max width/height
MAX_PX = 2500

# Time range
TIME_FROM = "2025-12-17T00:00:00Z"
TIME_TO   = "2026-01-17T23:59:59Z"

# Evalscript for true color RGB
EVALSCRIPT = """
//VERSION=3
function setup() {
  return {
    input: ["B02","B03","B04"],
    output: {bands:3}
  };
}

function evaluatePixel(sample) {
  return [
    2.5 * sample.B04,
    2.5 * sample.B03,
    2.5 * sample.B02
  ];
}
"""

# -----------------------------
# 1. TILES (from previous JSON)
# -----------------------------
TILES = [
    [-122.767945, 37.363892, -122.482845, 37.588492],
    [-122.482845, 37.363892, -122.197745, 37.588492],
    [-122.197745, 37.363892, -121.912645, 37.588492],
    [-121.912645, 37.363892, -121.627545, 37.588492],
    [-121.627545, 37.363892, -121.342445, 37.588492],
    [-121.342445, 37.363892, -121.198992, 37.588492],
    [-122.767945, 37.588492, -122.482845, 37.813092],
    [-122.482845, 37.588492, -122.197745, 37.813092],
    [-122.197745, 37.588492, -121.912645, 37.813092],
    [-121.912645, 37.588492, -121.627545, 37.813092],
    [-121.627545, 37.588492, -121.342445, 37.813092],
    [-121.342445, 37.588492, -121.198992, 37.813092],
    [-122.767945, 37.813092, -122.482845, 38.037692],
    [-122.482845, 37.813092, -122.197745, 38.037692],
    [-122.197745, 37.813092, -121.912645, 38.037692],
    [-121.912645, 37.813092, -121.627545, 38.037692],
    [-121.627545, 37.813092, -121.342445, 38.037692],
    [-121.342445, 37.813092, -121.198992, 38.037692],
    [-122.767945, 38.037692, -122.482845, 38.262292],
    [-122.482845, 38.037692, -122.197745, 38.262292],
    [-122.197745, 38.037692, -121.912645, 38.262292],
    [-121.912645, 38.037692, -121.627545, 38.262292],
    [-121.627545, 38.037692, -121.342445, 38.262292],
    [-121.342445, 38.037692, -121.198992, 38.262292],
    [-122.767945, 38.262292, -122.482845, 38.486892],
    [-122.482845, 38.262292, -122.197745, 38.486892],
    [-122.197745, 38.262292, -121.912645, 38.486892],
    [-121.912645, 38.262292, -121.627545, 38.486892],
    [-121.627545, 38.262292, -121.342445, 38.486892],
    [-121.342445, 38.262292, -121.198992, 38.486892],
    [-122.767945, 38.486892, -122.482845, 38.711492],
    [-122.482845, 38.486892, -122.197745, 38.711492],
    [-122.197745, 38.486892, -121.912645, 38.711492],
    [-121.912645, 38.486892, -121.627545, 38.711492],
    [-121.627545, 38.486892, -121.342445, 38.711492],
    [-121.342445, 38.486892, -121.198992, 38.711492],
    [-122.767945, 38.711492, -122.482845, 38.800412],
    [-122.482845, 38.711492, -122.197745, 38.800412],
    [-122.197745, 38.711492, -121.912645, 38.800412],
    [-121.912645, 38.711492, -121.627545, 38.800412],
    [-121.627545, 38.711492, -121.342445, 38.800412],
    [-121.342445, 38.711492, -121.198992, 38.800412]
]

# -----------------------------
# 2. Download loop
# -----------------------------
for idx, tile in enumerate(TILES):
    minLon, minLat, maxLon, maxLat = tile

    request_payload = {
        "input": {
            "bounds": {"bbox": [minLon, minLat, maxLon, maxLat]},
            "data": [{
                "type": "sentinel-2-l2a",
                "dataFilter": {
                    "timeRange": {"from": TIME_FROM, "to": TIME_TO},
                    "mosaickingOrder": "mostRecent"
                }
            }]
        },
        "output": {
            "width": MAX_PX,
            "height": MAX_PX,
            "responses": [
                {"identifier": "default", "format": {"type": "image/tiff"}}
            ]
        },
        "evalscript": EVALSCRIPT
    }

    print(f"Downloading tile {idx+1}/{len(TILES)}: {tile} ...")
    r = requests.post(
        "https://services.sentinel-hub.com/api/v1/process",
        headers={"Authorization": f"Bearer {API_KEY}", "Content-Type": "application/json"},
        json=request_payload,
        stream=True
    )
    
    if r.status_code != 200:
        print(f"ERROR downloading tile {idx+1}: {r.status_code} {r.text}")
        continue

    # Save the TIFF
    output_path = f"{OUTPUT_FOLDER}bay_area_tile_{idx+1}.tif"
    with open(output_path, "wb") as f:
        for chunk in r.iter_content(chunk_size=8192):
            f.write(chunk)

    print(f"Saved {output_path}")
    time.sleep(1)  # optional: prevent hitting API limits
